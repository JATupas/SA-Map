{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADE Project PH</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/stylesheet-SA-PGA.css' %}">

    <!-- Include Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>

<body>
    <header>
        <div class="header-container">
            <div class="logo-container">
                <img src="{% static 'images/SHADE LOGO.png' %}" alt="PHIVOLCS Logo" class="logo">
                <div class="text-container">
                    <h2>Philippine Institute of Volcanology and Seismology</h2>
                    <h1>SHADE PH</h1>
                </div>
            </div>
            <nav>
                <a href="{% url 'shade_redesign' %}" class="nav-link">Home</a>
                <a href="#About-section" class="nav-link">About</a>
                <span class="separator">|</span>
                <b href="#" class="nav-link">Register</b>
                <a href="#" class="nav-button">Log In</a>
            </nav>
        </div>
    </header>
    
    <main>
        <section class="Home" id="Home">
            <div class="container1">
                <div class="Title">
                    <h1>SHADE Project PH</h1>
                    <p>Seismic Hazard Assessment for Design Earthquake of the Philippines</p>
                </div>
                
                <div class="container2">
                    <div class="map-card">
                        <div id="map" class="map"></div> <!-- Map placed inside card -->
                    </div>

                    <div class="form">
                        <div class="form-card">
                            <div class="form-header">
                                <img src="{% static 'images/ORC Header.svg' %}" class="card-icon">
                                <h2>Ground Motion Intensity Measures</h2>
                            </div>                                   
                            
                            <div class="form-content">
                                <form id="coordinates-form" method="POST">
                                    {% csrf_token %}
                                    <!-- Current coordinates fields -->

                                    <button id="toggle-view" type="button" class="btn btn-primary">Switch to DMS</button>
                                    
                                    <div id="dms-fields" style="display: none;">
                                        <div class="mb-3">
                                            <label for="lon-degrees" class="form-label">Longitude (DMS)</label>
                                            <div class="d-flex">
                                                <input type="text" id="lon-degrees" class="form-control" placeholder="0.0°">
                                                <input type="text" id="lon-minutes" class="form-control" placeholder="0.0'">
                                                <input type="text" id="lon-seconds" class="form-control" placeholder="0.0''">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="lat-degrees" class="form-label">Latitude (DMS)</label>
                                            <div class="d-flex">
                                                <input type="text" id="lat-degrees" class="form-control" placeholder="0.0°">
                                                <input type="text" id="lat-minutes" class="form-control" placeholder="0.0'">
                                                <input type="text" id="lat-seconds" class="form-control" placeholder="0.0''">
                                            </div>
                                        </div>
                                    </div>

                                     <!-- Decimal Degrees Fields -->
                                    <div id="decimal-degrees-fields">
                                        <div class="mb-3">
                                            <label for="current-lon" class="form-label">Longitude (Decimal Degrees)</label>
                                            <input type="text" id="current-lon" class="form-control" placeholder="0.0">
                                        </div>
                                        <div class="mb-3">
                                            <label for="current-lat" class="form-label">Latitude (Decimal Degrees)</label>
                                            <input type="text" id="current-lat" class="form-control" placeholder="0.0">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="site" class="form-label">Site Classification</label>
                                        <input type="text" id="site" class="form-control" placeholder="A">
                                    </div>
                                </form>                          
                                <div class="button-group">
                                    <button type="button" id="check-data">Check Data</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                </div>
        
            <!-- Site Information and Graph Section -->
        <section class="site-info-graph-section">
            <div class="container3">
                <div class="site-info">
                    <h3>Site Information:</h3>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td class="SA-title">Latitude</td>
                                <td id="long" class="SA-value">{{ current_coord.lng|default:0.0 }}</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Longitude</td>
                                <td id="lat" class="SA-value">{{ current_coord.lat|default:0.0 }}</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Latitude (DMS)</td>
                                <td id="lat-dms">
                                    <div class="d-flex">
                                        <input type="text" id="lat-degrees" class="form-control" placeholder="0°" value="{{ current_coord.lat_degrees|default:0 }}" readonly>°
                                        <input type="text" id="lat-minutes" class="form-control" placeholder="0'" value="{{ current_coord.lat_minutes|default:0 }}" readonly>'
                                        <input type="text" id="lat-seconds" class="form-control" placeholder="0''" value="{{ current_coord.lat_seconds|default:0 }}" readonly>''
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="SA-title">Longitude (DMS)</td>
                                <td id="lon-dms">
                                    <div class="d-flex">
                                        <input type="text" id="lon-degrees" class="form-control" placeholder="0°" value="{{ current_coord.lon_degrees|default:0 }}" readonly>°
                                        <input type="text" id="lon-minutes" class="form-control" placeholder="0'" value="{{ current_coord.lon_minutes|default:0 }}" readonly>'
                                        <input type="text" id="lon-seconds" class="form-control" placeholder="0''" value="{{ current_coord.lon_seconds|default:0 }}" readonly>''
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="SA-title">Site Class</td>
                                <td id="site-class-info" class="SA-value">A</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SA₁</td>
                                <td id="sa1-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SA₀₂</td>
                                <td id="sa02-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Tₗ</td>
                                <td id="tl-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Fa</td>
                                <td id="Fa-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Fv</td>
                                <td id="Fv-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SMS</td>
                                <td id="SMS-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SM1</td>
                                <td id="SM1-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SDS</td>
                                <td id="SDS-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">SD1</td>
                                <td id="SD1-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">Ts</td>
                                <td id="Ts-value" class="SA-value">0.0</td>
                            </tr>
                            <tr>
                                <td class="SA-title">To</td>
                                <td id="To-value" class="SA-value">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="image-container" class="graph-container">
                    {% if image_base64 %}
                        <h3>ASCE 7-05 Plot</h3>
                        <img src="data:image/png;base64,{{ image_base64 }}" alt="Spectral Acceleration Plot">
                    {% endif %}
                </div>
            </div>
        </section>

            <div id="popup" class="popup" style="display: none;">
            </div>

        </section>

        <section class="background">
        </section>

        {% comment %} <section class="Info_Section1">
                <div class="Section1" id="About-section">
                    <img src="{% static 'images/NO IMAGE DARK.svg' %}" alt="Img 1" class="img2">
                    <div class="text">
                        <!-- <h4>Section title</h4> -->
                        <h5>Title</h5>
                        <p>Nunc, mattis arcu eu ut quisque quam. Nunc rhoncus, arcu venenatis consectetur facilisis. Nibh nibh porttitor lectus sit porta vestibulum. Gravida ultricies ultrices velit adipiscing nec ultricies curabitur adipiscing non. Porttitor feugiat at duis aliquam, viverra et amet. Duis pellentesque integer sem sit. Nisl praesent aliquam tellus metus sem id. Feugiat maecenas sollicitudin sed fusce turpis vel hendrerit. Commodo massa ac justo faucibus faucibus ipsum amet. Arcu tincidunt mattis lectus pellentesque in.</p>
                        <p>Nunc, mattis arcu eu ut quisque quam. Nunc rhoncus, arcu venenatis consectetur facilisis. Nibh nibh porttitor lectus sit porta vestibulum. Gravida ultricies ultrices velit adipiscing nec ultricies curabitur adipiscing non. Porttitor feugiat at duis aliquam, viverra et amet. Duis pellentesque integer sem sit. Nisl praesent aliquam tellus metus sem id. Feugiat maecenas sollicitudin sed fusce turpis vel hendrerit. Commodo massa ac justo faucibus faucibus ipsum amet. Arcu tincidunt mattis lectus pellentesque in.</p>
                    </div>
            </div>
        </section> {% endcomment %}

    </main>

    <footer>
        <nav>
            <a href="#">Our Vision</a>
            <a href="#">Features</a>
            <a href="#">Our Team</a>
            <a href="#">Latest News</a>
            <a href="#">Contact</a>
        </nav>
        <p>Copyright © SHADE PH 2024</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize the map after the page has fully loaded
            var map = L.map('map').setView([13.41, 122.56], 6);  // Set initial coordinates
            
            var marker = null;  // Marker variable to store the current marker on the map
    
            // Add a tile layer to the map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
    
            // Function to convert Decimal Degrees to DMS
            function convertToDMS(decimalDegree) {
                const degrees = Math.floor(decimalDegree); // Extract degrees
                const minutesDecimal = Math.abs((decimalDegree - degrees) * 60); // Convert remaining to minutes
                const minutes = Math.floor(minutesDecimal); // Extract whole minutes
                const seconds = ((minutesDecimal - minutes) * 60).toFixed(5); // Convert remaining to seconds with 5 decimals
                return { degrees, minutes, seconds };
            }
    
            // Map click event
            map.on('click', function(e) {
                var lat = e.latlng.lat;
                var lon = e.latlng.lng;
    
                // Update the latitude and longitude input fields
                document.getElementById('current-lat').value = lat;
                document.getElementById('current-lon').value = lon;
    
                // Update DMS fields for Latitude
                const latDMS = convertToDMS(lat);
                document.getElementById('lat-degrees').value = latDMS.degrees;
                document.getElementById('lat-minutes').value = latDMS.minutes;
                document.getElementById('lat-seconds').value = latDMS.seconds;
    
                // Update DMS fields for Longitude
                const lonDMS = convertToDMS(lon);
                document.getElementById('lon-degrees').value = lonDMS.degrees;
                document.getElementById('lon-minutes').value = lonDMS.minutes;
                document.getElementById('lon-seconds').value = lonDMS.seconds;
    
                // Check if the point is outside the Philippines
                if (lat < 4 || lat > 21 || lon < 116 || lon > 127) {
                    // Show the popup over the entire map
                    document.getElementById('popup').style.display = 'flex';
                    document.getElementById('popup').innerHTML = `
                        <div class="card">
                            <p>This point is outside of the Philippines, there is no available data for the selected coordinates.</p>
                            <button id="closePopup">Close</button>
                        </div>`;
    
                    // Close popup event listener
                    document.addEventListener('click', function(event) {
                        if (event.target && event.target.id === 'closePopup') {
                            document.getElementById('popup').style.display = 'none';
                        }
                    });
                }
    
                // If a marker exists, remove it
                if (marker) {
                    map.removeLayer(marker);
                }
    
                // Add a new marker at the clicked location
                marker = L.marker([lat, lon]).addTo(map);
            });
    
            // Add functionality to the "Check Data" button (for AJAX to update site information)
            document.getElementById('check-data').addEventListener('click', function() {
                var lat = document.getElementById('current-lat').value;
                var lon = document.getElementById('current-lon').value;
                var site = document.getElementById('site').value;  
                var latDegrees = document.getElementById('lat-degrees').value;
                var latMinutes = document.getElementById('lat-minutes').value;
                var latSeconds = document.getElementById('lat-seconds').value;

                var lonDegrees = document.getElementById('lon-degrees').value;
                var lonMinutes = document.getElementById('lon-minutes').value;
                var lonSeconds = document.getElementById('lon-seconds').value;

                document.getElementById('lat-dms').querySelector('#lat-degrees').value = latDegrees;
                document.getElementById('lat-dms').querySelector('#lat-minutes').value = latMinutes;
                document.getElementById('lat-dms').querySelector('#lat-seconds').value = latSeconds;

                document.getElementById('lon-dms').querySelector('#lon-degrees').value = lonDegrees;
                document.getElementById('lon-dms').querySelector('#lon-minutes').value = lonMinutes;
                document.getElementById('lon-dms').querySelector('#lon-seconds').value = lonSeconds;
    
                // Make sure lat, lon, and site values are available before sending AJAX
                if (lat && lon && site) {
                    $.ajax({
                        type: "POST",
                        url: "{% url 'sa_pga_map' %}",  // Ensure this URL resolves correctly in Django
                        data: {
                            'lat': lat,
                            'lon': lon,
                            'site': site,  // Send the site value as well
                            'csrfmiddlewaretoken': '{{ csrf_token }}',  // Include CSRF token if not exempted
                        },
                        success: function(response) {
                            console.log('Data updated successfully');
                            console.log(response);  // Handle the response from the server
                            // Optionally, you can handle any changes to the UI here (e.g., updating coordinates)
                            document.getElementById('long').textContent = response.current_coord.lon || lat;
                            document.getElementById('lat').textContent = response.current_coord.lat || lon;
                            document.getElementById('site-class-info').textContent = response.site || site;  // Assuming site class info is static for now
    
                            // Optionally, populate other fields like SA₁, SMS, etc.
                            document.getElementById('sa1-value').textContent = response.sa1 || '0.0';
                            document.getElementById('sa02-value').textContent = response.sa02 || '0.0';
                            document.getElementById('tl-value').textContent = response.tl || '0.0';
                            document.getElementById('Fa-value').textContent = response.Fa || '0.0';
                            document.getElementById('Fv-value').textContent = response.Fv || '0.0';
                            document.getElementById('SMS-value').textContent = response.SMS || '0.0';
                            document.getElementById('SM1-value').textContent = response.SM1 || '0.0';
                            document.getElementById('SDS-value').textContent = response.SDS || '0.0';
                            document.getElementById('SD1-value').textContent = response.SD1 || '0.0';
                            document.getElementById('Ts-value').textContent = response.Ts || '0.0';
                            document.getElementById('To-value').textContent = response.To || '0.0';
    
                            if (response.image_base64) {
                                document.getElementById('image-container').innerHTML = '<img src="data:image/png;base64,' + response.image_base64 + '" alt="SA-PGA Map Image">';
                            }
    
                            document.querySelector('.Home .container3').style.display = "flex";
                            var newLat = response.current_coord.lat || lat;
                            var newLon = response.current_coord.lon || lon;
                            if (marker) {
                                map.removeLayer(marker); // Remove any existing marker
                            }
                            marker = L.marker([newLat, newLon]).addTo(map);  // Add the new marker
                            map.setView([newLat, newLon], 11);  // Zoom in to the new marker
                        },
                        error: function(xhr, status, error) {
                            console.error('Error occurred while updating data:', error);
                            console.log(xhr.responseText);
                        }
                    });
                } else {
                    alert("Please fill in all required fields before submitting.");
                }
            });
        });
    </script>
    
    <script>
        // Function to convert Decimal Degrees to DMS
        function convertToDMS(decimalDegree) {
            const degrees = Math.floor(decimalDegree); // Extract degrees
            const minutesDecimal = Math.abs((decimalDegree - degrees) * 60); // Convert remaining to minutes
            const minutes = Math.floor(minutesDecimal); // Extract whole minutes
            const seconds = ((minutesDecimal - minutes) * 60).toFixed(5); // Convert remaining to seconds with 5 decimals
            return { degrees, minutes, seconds };
        }

        // Function to convert DMS to Decimal Degrees
        function convertToDecimalDegrees(degrees, minutes, seconds) {
            const decimalDegrees = Math.abs(degrees) + (minutes / 60) + (seconds / 3600); // Convert DMS to decimal
            return degrees < 0 ? -decimalDegrees : decimalDegrees; // Handle negative degrees
        }

        // Update DMS fields when Decimal Degrees change
        function updateDMSFields(lat, lon) {
            const latDMS = convertToDMS(lat);
            document.getElementById('lat-degrees').value = latDMS.degrees;
            document.getElementById('lat-minutes').value = latDMS.minutes;
            document.getElementById('lat-seconds').value = latDMS.seconds;

            const lonDMS = convertToDMS(lon);
            document.getElementById('lon-degrees').value = lonDMS.degrees;
            document.getElementById('lon-minutes').value = lonDMS.minutes;
            document.getElementById('lon-seconds').value = lonDMS.seconds;
        }

        // Update Decimal Degrees when DMS fields change
        function updateDecimalFields() {
            const latDegrees = parseInt(document.getElementById('lat-degrees').value || 0, 10);
            const latMinutes = parseFloat(document.getElementById('lat-minutes').value || 0);
            const latSeconds = parseFloat(document.getElementById('lat-seconds').value || 0);
            const latDecimal = convertToDecimalDegrees(latDegrees, latMinutes, latSeconds);
            document.getElementById('current-lat').value = latDecimal.toFixed(6);

            const lonDegrees = parseInt(document.getElementById('lon-degrees').value || 0, 10);
            const lonMinutes = parseFloat(document.getElementById('lon-minutes').value || 0);
            const lonSeconds = parseFloat(document.getElementById('lon-seconds').value || 0);
            const lonDecimal = convertToDecimalDegrees(lonDegrees, lonMinutes, lonSeconds);
            document.getElementById('current-lon').value = lonDecimal.toFixed(6);
        }

        // Event Listeners for Decimal Degrees Fields
        document.getElementById('current-lat').addEventListener('input', () => {
            const lat = parseFloat(document.getElementById('current-lat').value || 0);
            const lon = parseFloat(document.getElementById('current-lon').value || 0);
            updateDMSFields(lat, lon);
        });

        document.getElementById('current-lon').addEventListener('input', () => {
            const lat = parseFloat(document.getElementById('current-lat').value || 0);
            const lon = parseFloat(document.getElementById('current-lon').value || 0);
            updateDMSFields(lat, lon);
        });

        // Event Listeners for DMS Fields
        const dmsFields = ['lat-degrees', 'lat-minutes', 'lat-seconds', 'lon-degrees', 'lon-minutes', 'lon-seconds'];
        dmsFields.forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('input', updateDecimalFields);
        });

        // Select elements
        const toggleButton = document.getElementById('toggle-view');
        const decimalFields = document.getElementById('decimal-degrees-fields');
        const degminsecFields = document.getElementById('dms-fields');
        let showDecimal = true; // Initial state

        // Initial display state
        decimalFields.style.display = 'block'; // Display decimal degrees fields by default
        degminsecFields.style.display = 'none'; // Hide DMS fields initially

        // Toggle functionality
        toggleButton.addEventListener('click', () => {
            if (showDecimal) {
                decimalFields.style.display = 'none'; // Hide decimal degrees fields
                degminsecFields.style.display = 'block'; // Show DMS fields
                toggleButton.textContent = 'Switch to Decimal Degrees'; // Update button text
            } else {
                degminsecFields.style.display = 'none'; // Hide DMS fields
                decimalFields.style.display = 'block'; // Show decimal degrees fields
                toggleButton.textContent = 'Switch to DMS'; // Update button text
            }
            showDecimal = !showDecimal; // Toggle the state
        });

    </script>
    
    

</body>
</html>
